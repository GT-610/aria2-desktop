# Flutter 桌面端 Aria2 下载管理程序设计大纲

## 1. 项目概述

### 1.1 项目简介
设计并实现一个基于 Flutter 的跨平台桌面端 Aria2 下载管理程序，提供友好的用户界面来管理 Aria2 下载实例和任务。

### 1.2 目标平台
- Windows
- macOS
- Linux

### 1.3 主要功能
- Aria2 实例管理（本地和远程）
- 下载任务管理
- 实例配置设置
- 系统托盘集成
- 多平台适配

## 2. 技术架构

### 2.1 技术栈
- **前端框架**: Flutter
- **状态管理**: Provider 或 Bloc
- **网络请求**: Dio + WebSocket 客户端
- **系统托盘**: bitsdojo_window 或 system_tray 插件
- **本地存储**: shared_preferences 或 sqflite
- **进程管理**: dart:io 或 process_run 插件

### 2.2 整体架构设计
```
┌─────────────────────────────────────────────────────────────────┐
│                       UI Layer (Flutter)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  下载页面   │  │  实例页面   │  │     设置页面            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                     Business Logic Layer                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 下载管理器  │  │ 实例管理器  │  │ 配置管理器              │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│                      Data Access Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ Aria2 RPC   │  │ 本地存储    │  │ 进程管理                │  │
│  │ 客户端      │  │            │  │                        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 功能模块设计

### 3.1 实例管理模块

#### 3.1.1 核心功能
- 添加、编辑、删除实例
- 连接/断开实例
- 本地实例自动启动 Aria2 进程
- 实例状态监控

#### 3.1.2 数据模型
```dart
class Aria2Instance {
  String id;              // 唯一标识符
  String name;            // 实例名称
  InstanceType type;      // 本地或远程
  String protocol;        // HTTP/HTTPS/WS/WSS
  String host;            // 主机地址
  int port;               // 端口
  String secret;          // 密钥
  String? aria2Path;      // 本地实例的 Aria2 可执行文件路径
  String? version;        // Aria2 版本
  bool isActive;          // 是否为当前活动实例
  Process? localProcess;  // 本地进程引用
}

enum InstanceType {
  local,
  remote
}
```

#### 3.1.3 主要类和方法
- `InstanceManager`: 实例管理核心类
  - `addInstance()`
  - `updateInstance()`
  - `deleteInstance()`
  - `connectInstance()`
  - `disconnectInstance()`
  - `startLocalAria2()`
  - `stopLocalAria2()`
  - `getActiveInstance()`

### 3.2 RPC 客户端模块

#### 3.2.1 核心功能
- 封装 Aria2 JSON-RPC 协议
- 支持 HTTP/HTTPS/WS/WSS 连接
- 请求重试和错误处理
- 任务状态实时更新

#### 3.2.2 主要类和方法
- `Aria2RpcClient`: RPC 客户端核心类
  - `initialize()`: 初始化连接
  - `callMethod()`: 通用方法调用
  - `getVersion()`: 获取版本信息
  - `listDownloads()`: 获取下载列表
  - `tellStatus()`: 获取任务状态
  - `addUri()`: 添加下载链接
  - `pauseDownload()`: 暂停下载
  - `unpauseDownload()`: 继续下载
  - `removeDownload()`: 移除下载
  - `getGlobalStat()`: 获取全局统计信息
  - `setOption()`: 设置选项

### 3.3 下载管理模块

#### 3.3.1 核心功能
- 任务列表展示与筛选
- 任务添加、删除、暂停、继续
- 下载速度控制
- 任务详情查看

#### 3.3.2 数据模型
```dart
class DownloadTask {
  String gid;             // 任务唯一标识符
  String name;            // 任务名称
  DownloadStatus status;  // 下载状态
  double progress;        // 进度 (0.0-1.0)
  int totalLength;        // 总大小 (字节)
  int completedLength;    // 已完成大小 (字节)
  int downloadSpeed;      // 下载速度 (字节/秒)
  int remainingTime;      // 剩余时间 (秒)
  String downloadDir;     // 下载目录
  Aria2Instance instance; // 所属实例
}

enum DownloadStatus {
  active,
  waiting,
  paused,
  error,
  complete,
  removed
}
```

#### 3.3.3 主要类和方法
- `DownloadManager`: 下载管理核心类
  - `getTasks()`: 获取任务列表
  - `addTask()`: 添加下载任务
  - `deleteTask()`: 删除任务
  - `pauseTask()`: 暂停任务
  - `resumeTask()`: 继续任务
  - `setTaskSpeedLimit()`: 设置任务速度限制
  - `getTaskDetails()`: 获取任务详情

### 3.4 配置管理模块

#### 3.4.1 核心功能
- 实例配置的保存与加载
- 全局设置管理
- 配置验证

#### 3.4.2 主要类和方法
- `ConfigManager`: 配置管理核心类
  - `saveInstanceConfig()`: 保存实例配置
  - `loadInstanceConfig()`: 加载实例配置
  - `saveGlobalSettings()`: 保存全局设置
  - `loadGlobalSettings()`: 加载全局设置
  - `validateConfig()`: 验证配置

### 3.5 系统托盘模块

#### 3.5.1 核心功能
- 显示下载任务列表
- 最小化到系统托盘
- 窗口恢复
- 显示下载统计信息

#### 3.5.2 主要类和方法
- `SystemTrayManager`: 系统托盘管理核心类
  - `initialize()`: 初始化系统托盘
  - `showNotification()`: 显示通知
  - `updateTrayIcon()`: 更新托盘图标
  - `showTaskMenu()`: 显示任务菜单
  - `minimizeToTray()`: 最小化到托盘
  - `restoreFromTray()`: 从托盘恢复

## 4. 界面设计

### 4.1 主窗口布局
- 侧边导航栏：下载、实例、设置
- 主内容区域：根据选择显示不同页面
- 底部状态栏：显示全局下载统计

### 4.2 下载页面
- 标签页切换：所有任务 / 单个实例任务
- 任务列表：显示任务信息，支持排序和筛选
- 任务操作工具栏：添加、删除、暂停、继续等
- 任务详情面板：点击任务显示详细信息

### 4.3 实例页面
- 实例列表：显示所有配置的实例
- 实例状态指示器：在线/离线状态
- 实例操作：添加、编辑、删除、连接、断开
- 本地实例配置：Aria2 可执行文件路径设置

### 4.4 设置页面
- 全局设置：主题、语言、自动启动等
- 实例配置：为每个实例设置下载路径、速度限制等
- 代理设置
- 日志设置

## 5. 数据流设计

### 5.1 状态管理
- 使用 Provider/Bloc 进行状态管理
- 主要状态对象：
  - `InstanceState`: 管理实例相关状态
  - `DownloadState`: 管理下载任务相关状态
  - `ConfigState`: 管理配置相关状态

### 5.2 事件流
```
UI 交互 → 触发事件 → Bloc/Provider 处理 → 更新状态 → UI 刷新
```

## 6. 错误处理与日志

### 6.1 错误类型
- 连接错误：网络问题、实例不可用
- RPC 错误：命令执行失败
- 进程错误：本地 Aria2 进程启动失败
- 文件系统错误：文件读写权限问题

### 6.2 错误处理策略
- 连接错误自动重试
- 用户友好的错误提示
- 详细错误日志
- 失败恢复机制

## 7. 性能优化

### 7.1 资源管理
- WebSocket 连接池化
- 任务列表懒加载
- 大量任务时的虚拟滚动

### 7.2 响应性优化
- UI 更新防抖
- 异步操作不阻塞主线程

## 8. 开发计划

### 8.1 第一阶段：核心功能
- 实例管理基础功能
- RPC 客户端实现
- 基本下载任务管理
- 简单 UI 界面

### 8.2 第二阶段：完善功能
- 系统托盘集成
- 详细的任务信息展示
- 配置管理功能
- UI 美化与交互优化

### 8.3 第三阶段：优化与测试
- 性能优化
- 多平台适配
- 全面测试
- 文档完善

## 9. 依赖与插件

- flutter
- provider/bloc
- dio
- web_socket_channel
- shared_preferences/sqflite
- bitsdojo_window/system_tray
- process_run
- path_provider
- file_picker

## 10. 附录

### 10.1 Aria2 RPC API 参考
详细的 Aria2 JSON-RPC API 参考见：[Aria2 JSON-RPC API](https://aria2.document.top/zh/aria2c.html#id42)

### 10.2 设计考虑因素
- 跨平台兼容性：确保在 Windows、macOS 和 Linux 上一致运行
- 用户体验：简洁直观的界面，响应迅速的操作
- 稳定性：健壮的错误处理和恢复机制
- 可扩展性：模块化设计，便于功能扩展